# Custom Environment Example

## What This Demonstrates

This example shows how to control the test execution environment using:

- `--base-image <ref>` - Override the default base container image
- `--remote-user <name>` - Specify which user runs test scripts
- `--preserve-test-containers` - Keep containers after tests for debugging

## Default Behavior

Without these flags:
- **Base image**: `ubuntu:focal` (default)
- **Remote user**: `root` (container default)
- **Cleanup**: All test containers removed after execution

## Flags

### `--base-image`

Sets the default base image for autogenerated tests and scenarios that don't specify their own image.

```sh
# Use Debian instead of Ubuntu
deacon features test . --base-image debian:bullseye

# Use Alpine
deacon features test . --base-image alpine:latest

# Use specific Ubuntu version
deacon features test . --base-image ubuntu:jammy
```

**Note**: Scenarios with explicit `"image"` fields override `--base-image`.

### `--remote-user`

Specifies the user that runs install and test scripts inside containers.

```sh
# Run as non-root user
deacon features test . --remote-user vscode

# Run as specific user
deacon features test . --remote-user developer
```

**Important**: The user must exist in the container or creation will fail.

### `--preserve-test-containers`

Keeps test containers after execution for debugging.

```sh
# Keep containers for inspection
deacon features test . --preserve-test-containers

# List preserved containers
docker ps -a --filter "label=devcontainer.is_test_run=true"

# Inspect a preserved container
docker inspect <container-id>

# Manually remove when done
docker rm <container-id>
```

## Commands

```sh
# Use Alpine as base
deacon features test . --base-image alpine:latest

# Run tests as vscode user
deacon features test . --remote-user vscode

# Keep containers after tests
deacon features test . --preserve-test-containers

# Combine all three
deacon features test . \
  --base-image debian:bullseye \
  --remote-user developer \
  --preserve-test-containers
```

## Expected Output (--preserve-test-containers)

```text
Running features test suite...

Autogenerated Tests:
  ✓ tools

Summary: 1 test, 1 passed, 0 failed

⚠️ Test containers preserved (--preserve-test-containers set)
   Use: docker ps -a --filter "label=devcontainer.is_test_run=true"
```

## Use Cases

### Testing on Different Distributions

```sh
# Verify feature works on Debian
deacon features test . --base-image debian:bullseye

# Verify feature works on Alpine
deacon features test . --base-image alpine:latest

# CI matrix testing
for image in ubuntu:focal ubuntu:jammy debian:bullseye; do
  echo "Testing on $image..."
  deacon features test . --base-image "$image"
done
```

### Non-Root User Testing

```sh
# Ensure features work when run as non-root
deacon features test . --remote-user vscode

# Test with specific user requirements
deacon features test . --remote-user developer
```

### Debugging Failed Tests

```sh
# Run with preservation
deacon features test . --preserve-test-containers

# Find the container
CONTAINER=$(docker ps -a --filter "label=devcontainer.is_test_run=true" --format "{{.ID}}" | head -1)

# Inspect filesystem
docker exec $CONTAINER ls -la /usr/local/etc

# Check logs
docker logs $CONTAINER

# Interactive shell
docker exec -it $CONTAINER bash

# Cleanup when done
docker rm $CONTAINER
```

## Collection Structure

```
custom-environment/
├── src/
│   └── tools/
└── test/
    └── tools/
        ├── test.sh
        └── scenarios.jsonc  # Some scenarios override image
```

## Scenario Image Precedence

When a scenario specifies an image:

```jsonc
[
  {
    "name": "ubuntu-test",
    // Uses --base-image flag value
  },
  {
    "name": "alpine-test",
    "image": "alpine:latest"  // Overrides --base-image
  }
]
```

The `--base-image` flag only applies to the first scenario.

## Container Labels

All test containers are labeled for identification:

```sh
docker inspect <container> | jq '.[0].Config.Labels'
# {
#   "devcontainer.is_test_run": "true",
#   "devcontainer.feature_id": "tools",
#   "devcontainer.test_type": "autogenerated"
# }
```

## Related Examples

- `basic-test-suite/` - Default environment behavior
- `scenario-filtering/` - Scenarios with custom images
