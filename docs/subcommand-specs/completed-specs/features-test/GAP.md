# Features Test Implementation Gap Analysis

**Date**: 2025-10-13  
**Specification Version**: Based on `/docs/subcommand-specs/features-test/`  
**Implementation**: `deacon` CLI (Rust)

---

## Executive Summary

The current implementation of `deacon features test` is **minimally functional** but lacks approximately **80-90% of the features and capabilities** defined in the specification. The implementation only supports basic single-feature testing with a simple install script execution in an Alpine container, whereas the specification defines a comprehensive testing framework with multiple test modalities, scenario support, filtering, and extensive configuration options.

### Critical Gaps
1. ❌ No support for test collection structure (`src/` and `test/` directories)
2. ❌ No scenario testing support (`scenarios.json`)
3. ❌ No autogenerated test library (`dev-container-features-test-lib`)
4. ❌ No global scenarios support (`test/_global`)
5. ❌ Missing 90% of command-line flags and options
6. ❌ No test result aggregation or structured output
7. ❌ No duplicate/idempotence testing
8. ❌ No test filtering or selective execution
9. ❌ No proper cleanup mechanism with container labels

---

## 1. Command-Line Interface Gaps

### 1.1 Missing Required Flags

| Flag | Spec Status | Implementation | Notes |
|------|-------------|----------------|-------|
| `--project-folder, -p <path>` | Required (default `.`) | ❌ Missing | Only accepts positional `path` |
| `--features, -f <id...>` | Optional | ❌ Missing | Cannot select specific features |
| `--filter <string>` | Optional | ❌ Missing | No scenario filtering |
| `--global-scenarios-only` | Optional | ❌ Missing | No global scenarios support |
| `--skip-scenarios` | Optional | ❌ Missing | No scenarios support at all |
| `--skip-autogenerated` | Optional | ❌ Missing | No autogenerated tests |
| `--skip-duplicated` | Optional | ❌ Missing | No duplicate testing |
| `--permit-randomization` | Optional | ❌ Missing | N/A |
| `--base-image, -i <ref>` | Optional (default `ubuntu:focal`) | ❌ Missing | Hardcoded to `alpine:latest` |
| `--remote-user, -u <name>` | Optional | ❌ Missing | N/A |
| `--log-level <level>` | Optional (default `info`) | ⚠️ Partial | Uses tracing but no explicit flag |
| `--preserve-test-containers` | Optional | ❌ Missing | Containers removed but not labeled |
| `--quiet, -q` | Optional | ❌ Missing | No quiet mode |

**Current Implementation**:
```rust
Test {
    path: String,    // Only positional path
    json: bool,      // Only JSON output flag
}
```

**Specification Requires**:
```
devcontainer features test [--project-folder <path>] [options]
  --project-folder, -p <path>     Collection root (default .)
  --features, -f <id...>          Feature IDs to test
  --filter <string>               Scenario name filter
  --global-scenarios-only         Only test _global scenarios
  --skip-scenarios               Skip scenario tests
  --skip-autogenerated           Skip test.sh tests
  --skip-duplicated              Skip duplicate tests
  --base-image, -i <ref>         Base image (default ubuntu:focal)
  --remote-user, -u <name>       Remote user
  --log-level <level>            Logging level
  --preserve-test-containers     Keep containers after tests
  --quiet, -q                    Reduce verbosity
```

### 1.2 Argument Validation Gaps

| Validation | Spec Requirement | Implementation | Gap |
|------------|------------------|----------------|-----|
| Mutual exclusivity | `--global-scenarios-only` vs `--features` | ❌ Missing | No enforcement |
| Mutual exclusivity | `--skip-scenarios` vs `--global-scenarios-only` | ❌ Missing | No enforcement |
| Mutual exclusivity | `--filter` vs `--skip-scenarios` | ❌ Missing | No enforcement |
| Directory structure | Requires `src/` and `test/` subdirs | ❌ Missing | No validation |
| Feature ID validation | Features must exist in `test/<id>/` | ❌ Missing | No validation |

---

## 2. Test Discovery and Structure Gaps

### 2.1 Expected Directory Layout (Per Spec)

**Specification Requires**:
```
<project-folder>/
  src/
    <feature-id>/
      devcontainer-feature.json
      install.sh
      ...
  test/
    <feature-id>/
      test.sh              # Autogenerated test
      scenarios.json       # Scenario definitions (optional)
      scenario1.sh         # Per-scenario scripts
      scenario2.sh
      ...
    _global/
      scenarios.json       # Global scenarios (optional)
      global-test.sh
      ...
```

**Current Implementation**:
- Accepts only a single feature directory path
- No concept of collection structure with `src/` and `test/`
- No test discovery mechanism
- No support for multiple features in one invocation

### 2.2 Test Modality Support

| Test Type | Spec Requirement | Implementation | Status |
|-----------|------------------|----------------|--------|
| **Autogenerated tests** | Run `test.sh` for each feature | ❌ Missing | No test.sh support |
| **Scenario tests** | Parse `scenarios.json` and run scenarios | ❌ Missing | No scenario support |
| **Duplicate/Idempotence tests** | Run install twice, verify idempotence | ❌ Missing | Single install only |
| **Global scenarios** | Run tests in `test/_global/` | ❌ Missing | No global support |

**Current Implementation**:
- Only runs `install.sh` directly in an Alpine container
- No test library injection
- No scenario parsing or execution
- No duplicate testing

---

## 3. Test Execution Gaps

### 3.1 Test Library (dev-container-features-test-lib)

**Specification Requires**:
- Inject helper script `dev-container-features-test-lib` into workspace
- Provide test assertion helpers for `test.sh` scripts
- Available functions for validation and checks

**Current Implementation**:
- ❌ No test library
- ❌ No helper script generation or injection
- ❌ Direct execution of install.sh without test scaffolding

### 3.2 Container Lifecycle

| Aspect | Spec Requirement | Implementation | Gap |
|--------|------------------|----------------|-----|
| Container labeling | Label with `devcontainer.is_test_run=true` | ❌ Missing | No labels |
| Cleanup mechanism | Query by label and remove | ❌ Missing | Uses `--rm` only |
| Base image | Configurable via `--base-image` | ❌ Hardcoded | `alpine:latest` only |
| Remote user | Configurable via `--remote-user` | ❌ Missing | N/A |
| Workspace preparation | Copy test dir to temp workspace | ❌ Partial | Mounts directly |

**Current Implementation**:
```rust
Command::new("docker")
    .args([
        "run",
        "--rm",                              // Basic cleanup only
        "-v", &feature_mount,                // Direct mount
        "alpine:latest",                     // Hardcoded image
        "sh", "-c",
        "cd /tmp/feature && chmod +x install.sh && ./install.sh",
    ])
```

**Should Be** (per spec):
```
1. Create temp workspace with test files
2. Write dev-container-features-test-lib helper
3. Launch container with label devcontainer.is_test_run=true
4. Execute test.sh (not install.sh directly)
5. Collect results
6. Cleanup by label unless --preserve-test-containers
```

### 3.3 Scenario Testing

**Specification Requires**:
```json
// test/<feature>/scenarios.json
{
  "scenario-name": {
    "build": {
      "dockerfile": "Dockerfile"
    },
    "features": {
      "ghcr.io/devcontainers/features/common-utils:1": {}
    }
  }
}
```

- Parse scenario definitions as DevContainerConfig
- Create workspace per scenario
- Execute scenario-specific scripts
- Aggregate results

**Current Implementation**:
- ❌ No scenario parsing
- ❌ No JSONC support
- ❌ No per-scenario execution
- ❌ No scenario script handling

---

## 4. Output and Results Gaps

### 4.1 Result Structure

**Specification Defines**:
```json
[
  {
    "testName": "feature-id",
    "result": true
  },
  {
    "testName": "feature-id (scenario-name)",
    "result": false
  },
  {
    "testName": "feature-id (duplicate/idempotence)",
    "result": true
  }
]
```

**Current Implementation**:
```json
{
  "command": "test",
  "status": "success|failure",
  "message": "..."
}
```

**Gaps**:
- ❌ No per-test results array
- ❌ No test name tracking
- ❌ No aggregation of multiple test results
- ❌ Single pass/fail for entire execution
- ❌ No summary of which tests passed/failed

### 4.2 Text Output

**Specification Requires**:
- Banner with CLI version
- Blue/bold headings for sections
- Per-test logs with icons (✓/✗)
- Final summary table
- Quiet mode support

**Current Implementation**:
- Basic tracing logs
- Generic success/failure message
- No formatting or structure
- No summary table

---

## 5. Error Handling Gaps

### 5.1 Missing Error Cases

| Error Scenario | Spec Behavior | Current Implementation |
|----------------|---------------|------------------------|
| Missing `src/` or `test/` | Exit 1 with clear message | ❌ Not checked |
| Missing `test.sh` | Exit 1 with message | ❌ Not checked (wrong file) |
| Scenario parse error | List errors, exit 1 | ❌ No scenarios |
| Invalid flag combinations | Argument parser error | ❌ No such flags |
| Docker unavailable | Surface error, exit non-zero | ⚠️ **CRITICAL BUG**: Returns success! |

**Critical Bug Found**:
```rust
Err(e) => {
    debug!("Failed to run docker command: {}", e);
    info!("Docker not available for feature testing - skipping container test");
    Ok(true) // ❌ BUG: Returns success when Docker is unavailable!
}
```

This **violates Prime Directive 6** from `.github/copilot-instructions.md`:
> **No Silent Fallbacks / Stubbed Behavior**: Production code MUST NOT transparently downgrade, noop, or silently substitute mock/stub implementations... Either provide a fully working implementation, OR emit a clear, user-facing error and abort the workflow.

### 5.2 Silent Failures

- **Docker unavailable**: Currently returns `Ok(true)` instead of failing
- **Should**: Return clear error and exit with non-zero code

---

## 6. Configuration and Workspace Gaps

### 6.1 Configuration Resolution

**Specification States**:
- CLI flags only (no devcontainer.json for test selection)
- Scenario configs parsed as standalone DevContainerConfig
- Variable substitution follows normal config rules

**Current Implementation**:
- Only accepts feature path
- No workspace resolution
- No configuration merging
- No variable substitution support

### 6.2 Workspace Management

| Aspect | Spec Requirement | Implementation | Gap |
|--------|------------------|----------------|-----|
| Temp workspace creation | Per test/scenario | ❌ Missing | Direct mount only |
| Helper script injection | Write test library | ❌ Missing | No library |
| File copying | Copy test files | ❌ Missing | Mount read-only |
| Cleanup | Remove temp dirs | ❌ Missing | N/A (no temp dirs) |

---

## 7. Cross-Platform and Edge Cases

### 7.1 Cross-Platform Support

| Platform | Spec Requirement | Current Status |
|----------|------------------|----------------|
| Linux | Full support | ✅ Likely works |
| macOS | Full support | ⚠️ Untested |
| Windows | Normalized paths | ⚠️ Untested |
| WSL2 | WSL2 docker | ⚠️ Untested |

### 7.2 Edge Cases Not Handled

- ❌ Empty `test/` directory
- ❌ Scenario name collisions
- ❌ Network failures during image pulls
- ❌ Container exits during script execution
- ❌ Read-only filesystems
- ❌ Missing scenarios.json with expected scenarios

---

## 8. Security Considerations

### 8.1 Security Gaps

| Security Aspect | Spec Guidance | Current Implementation |
|-----------------|---------------|------------------------|
| Container sandboxing | Recommend sandboxing | ⚠️ Basic isolation only |
| Secret redaction | Avoid mounting sensitive paths | ⚠️ No restrictions |
| Test script trust | Treat as untrusted | ⚠️ No sandboxing |
| Ephemeral cleanup | Remove by default | ⚠️ Uses --rm only |

---

## 9. Testing and Documentation Gaps

### 9.1 Test Coverage

**Current Tests** (in `test_features_cli.rs`):
- ✅ Valid feature with install.sh
- ✅ Missing metadata file
- ✅ Missing install.sh file
- ✅ JSON output format

**Missing Tests** (per spec):
- ❌ Collection structure validation
- ❌ Scenario parsing
- ❌ Multiple feature execution
- ❌ Flag combinations and exclusivity
- ❌ Filtering and selection
- ❌ Global scenarios
- ❌ Duplicate testing
- ❌ Cleanup behavior
- ❌ Base image configuration
- ❌ Result aggregation

### 9.2 Documentation Gaps

**Current Documentation**:
- Basic CLI help text
- Examples mention `features test` briefly

**Missing Documentation**:
- ❌ No comprehensive testing guide
- ❌ No example test collection structure
- ❌ No scenario examples
- ❌ No test.sh template
- ❌ No dev-container-features-test-lib documentation
- ❌ No best practices guide

---

## 10. Priority Recommendations

### 10.1 Critical (Must Fix)

1. **Fix silent Docker failure** (violates Prime Directive 6)
   ```rust
   // Current (WRONG):
   Err(e) => Ok(true)
   
   // Should be:
   Err(e) => Err(anyhow!("Docker is required for feature testing: {}", e))
   ```

2. **Implement collection structure** (`--project-folder`, `src/`, `test/`)
   - Validate directory structure
   - Discover features from `src/`
   - Map to test directories

3. **Add autogenerated test support** (`test.sh`)
   - Generate test library helper
   - Execute test.sh instead of install.sh
   - Collect and report results

### 10.2 High Priority

4. **Implement scenario testing**
   - Parse scenarios.json (JSONC)
   - Create workspaces per scenario
   - Execute scenario scripts
   - Aggregate results

5. **Add proper container labeling and cleanup**
   - Label containers with `devcontainer.is_test_run=true`
   - Implement cleanup by label
   - Support `--preserve-test-containers`

6. **Implement flag support**
   - `--features, -f` for selection
   - `--base-image, -i` for configuration
   - `--skip-*` flags for control
   - `--filter` for scenario filtering

### 10.3 Medium Priority

7. **Add duplicate/idempotence testing**
8. **Implement global scenarios** (`test/_global`)
9. **Improve output formatting** (structured results, summaries)
10. **Add comprehensive examples** and documentation

### 10.4 Low Priority

11. **Add quiet mode** (`--quiet, -q`)
12. **Support `--remote-user`** configuration
13. **Implement `--permit-randomization`** for test variations

---

## 11. Implementation Estimate

### Phase 1: Critical Fixes (1-2 days)
- Fix Docker failure bug
- Add basic collection structure validation
- Implement `--project-folder` flag

### Phase 2: Core Features (1-2 weeks)
- Test library generation and injection
- Autogenerated test execution (test.sh)
- Basic scenario parsing and execution
- Container labeling and cleanup
- Result aggregation

### Phase 3: Advanced Features (1-2 weeks)
- Full scenario support with JSONC parsing
- Global scenarios
- Duplicate testing
- Filtering and selection
- All CLI flags

### Phase 4: Polish (1 week)
- Comprehensive examples
- Documentation
- Edge case handling
- Cross-platform testing

**Total Estimate**: 4-6 weeks for full specification compliance

---

## 12. Specification Compliance Summary

| Category | Compliance | Details |
|----------|------------|---------|
| **CLI Flags** | ~10% | 2/13 flags implemented |
| **Test Discovery** | 0% | No collection structure |
| **Test Modalities** | 15% | Basic install only, no scenarios |
| **Container Management** | 20% | Basic execution, no labeling |
| **Output Format** | 30% | JSON exists but wrong structure |
| **Error Handling** | 40% | Some validation, **critical bug** |
| **Documentation** | 20% | Minimal examples |
| **Testing** | 30% | Basic tests only |
| **Overall Compliance** | **~20%** | Minimal viable implementation |

---

## 13. References

- **Specification**: `/workspaces/deacon/docs/subcommand-specs/features-test/SPEC.md`
- **Data Structures**: `/workspaces/deacon/docs/subcommand-specs/features-test/DATA-STRUCTURES.md`
- **Diagrams**: `/workspaces/deacon/docs/subcommand-specs/features-test/DIAGRAMS.md`
- **Implementation**: `/workspaces/deacon/crates/deacon/src/commands/features.rs` (lines 313-357)
- **CLI Definition**: `/workspaces/deacon/crates/deacon/src/cli.rs` (lines 330-342)
- **Tests**: `/workspaces/deacon/crates/deacon/tests/test_features_cli.rs`
- **Prime Directives**: `/workspaces/deacon/.github/copilot-instructions.md`

---

## Appendix A: Side-by-Side Comparison

### Command Invocation

**Spec**:
```bash
devcontainer features test --project-folder ./my-features \
  --features feature1 feature2 \
  --filter "integration" \
  --base-image ubuntu:22.04 \
  --skip-duplicated
```

**Current**:
```bash
deacon features test ./my-features/src/feature1 --json
# Only single feature, no options
```

### Output

**Spec**:
```
Dev Container Features v1.0.0
============================

Testing feature1...
  ✓ Autogenerated test passed
  ✓ Scenario: basic (2.1s)
  ✗ Scenario: integration (failed)
  ✓ Duplicate install test passed

Testing feature2...
  ✓ Autogenerated test passed
  ✓ Scenario: basic (1.8s)

Summary:
--------
6 tests run, 5 passed, 1 failed

Exit code: 1
```

**Current**:
```json
{
  "command": "test",
  "status": "success",
  "message": "Feature test completed successfully"
}
```

---

**End of Gap Analysis**
