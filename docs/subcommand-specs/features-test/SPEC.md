# Features Test Subcommand Design Specification

## 1. Subcommand Overview
- Purpose: Execute automated tests for Dev Container Features in an isolated container environment. Supports per‑feature autogenerated tests, scenario tests, duplicate/idempotence tests, and global scenarios.
- User Personas:
  - Feature authors: Validate installation scripts, options, and behavior across scenarios.
  - CI engineers: Run feature test suites in pipelines with deterministic outcomes.
  - Maintainers: Reproduce and triage failures with clear logs and exit codes.
- Specification References:
  - Dev Container Features distribution and authoring: containers.dev implementors spec (Features)
  - Feature lifecycle and metadata fields (installsAfter, options, etc.): containers.dev implementors spec (Features Metadata)
  - Testing guidance (community docs) aligns with CLI behavior but is non‑normative.
- Related Commands:
  - `features package`: Package features once tests pass.
  - `features publish`: Publish tested packages to OCI.
  - `features info`: Inspect feature metadata and dependencies.

## 2. Command-Line Interface
- Full Syntax:
  - `devcontainer features test [--project-folder <path>] [options]`
- Flags and Options (from TS CLI):
  - `--project-folder, -p <path>`: Collection root containing `src/` and `test/` (default `.`). Preferred over deprecated positional.
  - `--features, -f <id...>`: One or more feature IDs to test. Omit to test all; cannot combine with `--global-scenarios-only`.
  - `--filter <string>`: Only run scenarios whose names include this substring; cannot combine with `--skip-scenarios`.
  - `--global-scenarios-only` (boolean): Only run tests under `test/_global`; cannot combine with `-f`.
  - `--skip-scenarios` (boolean): Skip scenario tests; cannot combine with `--global-scenarios-only`.
  - `--skip-autogenerated` (boolean): Skip `test.sh` autogenerated tests.
  - `--skip-duplicated` (boolean): Skip duplicate/idempotence test.
  - `--permit-randomization` (boolean): Allow randomized elements in tests.
  - `--base-image, -i <ref>`: Base image for autogenerated tests (default `ubuntu:focal`).
  - `--remote-user, -u <name>`: Remote user for tests (not used for scenarios unless substituted in scenario config).
  - `--log-level <info|debug|trace>`: Logging level (default `info`).
  - `--preserve-test-containers` (boolean): Do not remove test containers after runs.
  - `--quiet, -q` (boolean): Reduce output verbosity.
  - Deprecated positional: `target` (collection root). Prefer `--project-folder`.
- Flag Taxonomy:
  - Required: none.
  - Optional: all flags above; positional `target` is deprecated.
  - Mutually exclusive: `--global-scenarios-only` with `--features`; `--skip-scenarios` with `--global-scenarios-only`; `--filter` with `--skip-scenarios`.
- Argument Validation Rules:
  - `--project-folder` must contain both `src/` and `test/`. Error if missing.
  - `--features` values must correspond to subfolders under `test/` for scenario discovery; missing folders are errors.
  - `--filter` is a substring match on scenario names.
  - `--base-image` must be a valid image ref (format not strictly validated by CLI; docker pull/build errors surface later).

## 3. Input Processing Pipeline

```pseudocode
FUNCTION parse_command_arguments(args) -> ParsedInput:
    input.project_folder = args['--project-folder'] OR args.positional('target') OR '.'
    input.features = to_array(args['--features']) OR undefined
    input.filter = args['--filter']
    input.global_only = args['--global-scenarios-only']
    input.skip_scenarios = args['--skip-scenarios']
    input.skip_autogenerated = args['--skip-autogenerated']
    input.skip_duplicate = args['--skip-duplicated']
    input.permit_random = args['--permit-randomization']
    input.base_image = args['--base-image'] OR 'ubuntu:focal'
    input.remote_user = args['--remote-user']
    input.log_level = map_log_level(args['--log-level'])
    input.preserve = args['--preserve-test-containers']
    input.quiet = args['--quiet']

    // Validate exclusivity
    IF input.global_only AND input.features IS NOT UNDEFINED THEN ERROR('Cannot combine --global-scenarios-only and --features')
    IF input.skip_scenarios AND input.global_only THEN ERROR('Cannot combine --skip-scenarios and --global-scenarios-only')
    IF input.filter AND input.skip_scenarios THEN ERROR('Cannot combine --filter and --skip-scenarios')

    // Verify structure
    REQUIRE folder_exists(join(input.project_folder, 'src'))
    REQUIRE folder_exists(join(input.project_folder, 'test'))

    RETURN input
END FUNCTION
```

## 4. Configuration Resolution
- Sources and Precedence:
  - CLI flags only. No `devcontainer.json` configuration is read for test selection.
  - Scenario configs are read from the `test/` tree per feature or `_global`.
- Merge/Resolution:
  - Not applicable to CLI flags; scenario JSONC files are parsed as standalone devcontainer configs per scenario.
- Variable Substitution:
  - Scenario configs are parsed and used as input to environment creation; substitution follows normal config rules inside the test container creation helper (see containers.dev spec for variables). The test runner itself does not perform variable expansion.

## 5. Core Execution Logic

```pseudocode
FUNCTION execute_subcommand(input: ParsedInput) -> ExecutionResult:
    // Phase 1: Initialization
    cli_host = detect_cli_host(CWD)
    pkg = read_package_config()
    logger = create_logger(level=input.log_level)
    print_banner('Dev Container Features', pkg.version)

    // Phase 2: Pre-execution validation
    ASSERT exists(input.project_folder/src) AND exists(input.project_folder/test)

    // Phase 3: Main execution
    results = []
    IF input.global_only THEN
        results += run_global_tests(input)
    ELSE
        results += run_feature_tests(input)
        IF input.features IS UNDEFINED THEN
            results += run_global_tests(input)
        END IF
    END IF

    IF NOT input.preserve THEN cleanup_test_containers(cli_host)

    // Phase 4: Post-execution
    all_passed = every(results, r => r.result == true)
    print_summary(results, all_passed)
    RETURN Success if all_passed ELSE Failure
END FUNCTION

FUNCTION run_feature_tests(input) -> [TestResult]:
    for feature in select_features(input):
        log_info("Starting '%s' tests", feature)
        feature_test_dir = join(input.project_folder, 'test', feature)
        if NOT input.skip_autogenerated:
            workspace = prepare_autotest_workspace(feature_test_dir)
            create_container_from_workspace(workspace, input)
            write_test_library(workspace)
            ok = exec_script_in_container('test.sh', workspace)
            results.push({ testName: feature, result: ok })
        if NOT input.skip_scenarios:
            do_scenarios(feature_test_dir, feature, input, results)
        if NOT input.skip_duplicate:
            ok = run_duplicate_install_test(feature, input)
            results.push({ testName: feature + ' (duplicate)', result: ok })
    return results
END FUNCTION

FUNCTION run_global_tests(input) -> [TestResult]:
    path = join(input.project_folder, 'test', '_global')
    if exists(path):
        do_scenarios(path, '_global', input, results)
    return results
END FUNCTION
```

## 6. State Management
- Persistent State: None by default. Temporary workspaces created under system temp directory for scenarios and autogenerated tests.
- Cache Management: None specific; relies on Docker layer cache implicitly when building.
- Lock Files: None created.
- Idempotency: Safe to re‑run; containers are labeled `devcontainer.is_test_run=true` and removed unless `--preserve-test-containers`.

## 7. External System Interactions

### Docker/Container Runtime
```pseudocode
FUNCTION cleanup_test_containers(cli_host):
    ids = docker('ps -a --filter label=devcontainer.is_test_run=true --format {{.ID}}')
    FOR id IN ids: docker('rm -f', id)
END FUNCTION

FUNCTION create_container_from_workspace(params, workspace, input):
    // Uses devcontainers engine helpers to launch; honors base_image/remote_user where applicable
    launch_devcontainer(workspace, base_image=input.base_image, remote_user=input.remote_user)
END FUNCTION
```

### File System
- Reads `test/<feature>/test.sh`, optional `test/<feature>/scenarios.json`, and per‑scenario scripts `<scenario>.sh`.
- Copies test directories into ephemeral workspace folders for execution; writes a helper script `dev-container-features-test-lib` alongside.
- Scenario files are JSONC; parse with tolerant parser.

## 8. Data Flow Diagrams

```
┌───────────────┐
│ CLI Arguments │
└──────┬────────┘
       │
       ▼
┌───────────────────┐
│ Parse & Validate  │
└──────┬────────────┘
       │
       ▼
┌───────────────────┐      ┌──────────────┐
│ Select Tests      │◀────▶│ test/ layout │
└──────┬────────────┘      └──────────────┘
       │
       ▼
┌───────────────────┐  docker  ┌────────────────┐
│ Prepare Workspace │──────────▶│ Launch/Execute │
└──────┬────────────┘          └────────────────┘
       │                              │
       ▼                              ▼
┌───────────────────┐          ┌───────────────┐
│ Collect Results   │─────────▶│ Summarize/Exit│
└───────────────────┘          └───────────────┘
```

## 9. Error Handling Strategy
- User Errors:
  - Missing `src/` or `test/` folder: exit 1 with clear message.
  - Missing `test.sh` for a feature while autogenerated tests enabled: exit 1 with message.
  - Scenario JSONC parse errors: list parse errors then exit 1.
- System Errors:
  - Docker unavailable or failing commands: surface stderr; exit non‑zero.
  - Image pull/build failures: surface docker error; exit non‑zero.
- Configuration Errors:
  - Invalid combinations of flags: fail argument parsing with helpful message.

## 10. Output Specifications
- Standard Output (text mode):
  - Banner with CLI version; blue/bold headings; per‑test logs with icons (info/warn).
  - Final summary: list of tests and pass/fail; exit code 0 if all pass, 1 otherwise.
  - Quiet mode reduces informational logs but still shows failures.
- JSON Mode: Not provided by TS CLI for `features test`. If adding in Rust, define a schema `[ { testName: string, result: boolean } ]` with aggregate status.
- Standard Error: Internal logs and errors; obeys `--log-level`.
- Exit Codes: `0` success (all passed), `1` any failure or validation error.

## 11. Performance Considerations
- Serial execution by default; scenario containers are launched sequentially.
- Potential optimization: parallelize independent scenarios with resource caps; ensure logs remain readable.
- Resource Limits: Constrained by Docker and host; no special tuning performed.

## 12. Security Considerations
- Running arbitrary test scripts; treat as untrusted code. Recommend sandboxing on CI and redacting secrets from logs.
- No secrets are read by default; environment comes from scenarios. Avoid mounting sensitive host paths.
- Containers are ephemeral and removed by default to limit footprint.

## 13. Cross-Platform Behavior

| Aspect | Linux | macOS | Windows | WSL2 |
|--------|-------|-------|---------|------|
| Path handling | POSIX paths | POSIX paths | Paths normalized via CLI host | POSIX within WSL |
| Docker socket | `/var/run/docker.sock` | Docker Desktop | Docker Desktop | WSL2 distro docker |
| User ID mapping | Uses `remoteUser` if provided | Same | `remoteUser` resolved in container | Same |

## 14. Edge Cases and Corner Cases
- Empty `test/` or no matching features.
- Scenario names colliding with file system reserved names.
- Network partitions during image pulls.
- Container exits during test script execution.
- Read‑only file systems in ephemeral workspace (fail fast).

## 15. Testing Strategy

```pseudocode
TEST SUITE: features test
  TEST "happy path single feature":
    GIVEN valid feature test.sh
    WHEN run with --features <id>
    THEN exit 0 and show success summary

  TEST "scenario parsing error":
    GIVEN malformed scenarios.json
    WHEN run
    THEN exit 1 and list parse errors

  TEST "flag exclusivity":
    GIVEN --global-scenarios-only and -f provided
    THEN argument parser errors before execution

  TEST "cleanup behavior":
    GIVEN containers created
    WHEN run without --preserve-test-containers
    THEN no containers remain with test label
END SUITE
```

## 16. Migration Notes
- Deprecated Behavior: Positional `target` is deprecated in favor of `--project-folder`.
- Breaking Changes: None.
- Compatibility Shims: Continue to accept positional but prefer and document `--project-folder`.

### Selected Design Decisions

#### Design Decision: Dual test modalities (autogenerated + scenarios)
Implementation Behavior:
- Runs `test.sh` for each feature as a smoke test; also runs named scenarios from JSONC with separate scripts.

Specification Guidance:
- Spec defines feature composition; testing is out‑of‑scope but follows best practices for validating install hooks and options.

Rationale:
- Autogenerated tests catch basic regressions cheaply; scenarios capture complex dependency chains and options.

Alternatives Considered:
- Only scenario tests; slower to author and run.

Trade-offs:
- More moving parts; better coverage and developer ergonomics.

