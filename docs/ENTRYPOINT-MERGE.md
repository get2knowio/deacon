# Entrypoint Merge Semantics

This document describes the deterministic entrypoint merge behavior for compose-based devcontainers with features.

## Overview

When using features with compose-based devcontainers, entrypoints from different sources must be merged in a deterministic way to ensure that:
1. Feature initialization hooks execute correctly
2. Compose service entrypoints are respected
3. Base image entrypoints are preserved when appropriate

## Merge Precedence

Entrypoints are merged according to the following precedence order (highest to lowest):

1. **Explicit compose service entrypoint** (highest precedence)
   - If a compose service defines an `entrypoint`, it always takes precedence
   - Feature entrypoints are ignored in this case
   
2. **Feature-provided entrypoints** (middle precedence)
   - Features can define `entrypoint` in their `devcontainer-feature.json`
   - Multiple features with entrypoints are handled according to the merge strategy
   
3. **Base image/Dockerfile entrypoint** (lowest precedence)
   - The entrypoint from the base Docker image or Dockerfile
   - Used as fallback when no compose or feature entrypoints are present

## Merge Strategies

Three strategies are available for handling feature entrypoints when no explicit compose entrypoint is present:

### Wrap Strategy (Default)

The `wrap` strategy creates a wrapper script that:
1. Executes feature entrypoints in installation order
2. Invokes the original base entrypoint (if present)
3. Passes through all arguments

**Use case**: When features need to perform initialization before the main container process starts.

**Example**:
```json
{
  "features": {
    "ghcr.io/devcontainers/features/node:1": {
      "entrypoint": "/usr/local/share/nvm/init.sh"
    },
    "ghcr.io/devcontainers/features/python:1": {
      "entrypoint": "/usr/local/share/python/init.sh"
    }
  }
}
```

Result: Wrapper script executes in order:
1. `/usr/local/share/nvm/init.sh`
2. `/usr/local/share/python/init.sh`
3. Base image entrypoint (if present)

### Ignore Strategy

The `ignore` strategy skips all feature entrypoints and uses only the base entrypoint.

**Use case**: When features should not modify the container startup behavior.

**CLI flag**: `--feature-entrypoint=ignore`

### Replace Strategy

The `replace` strategy uses the last feature's entrypoint, completely replacing the base entrypoint.

**Use case**: When a feature needs complete control over container startup.

**CLI flag**: `--feature-entrypoint=replace`

## Generated Wrapper Script

When using the `wrap` strategy, a shell script is generated with the following structure:

```bash
#!/bin/sh
# DevContainer entrypoint wrapper
# Generated by deacon entrypoint merger

set -e

# Feature: node
echo "Running feature 'node' entrypoint..."
/usr/local/share/nvm/init.sh

# Feature: python
echo "Running feature 'python' entrypoint..."
/usr/local/share/python/init.sh

# Original entrypoint
echo "Invoking original entrypoint..."
exec /bin/bash "$@"
```

Key properties:
- Uses `set -e` to fail fast on errors
- Logs each step for debugging
- Uses `exec` for the final entrypoint to maintain PID 1
- Passes all arguments through with `"$@"`

## Error Handling

### Conflicting Directives

When multiple features define conflicting entrypoints with no safe merge strategy:

1. A warning is logged noting the conflict
2. The default `wrap` strategy is applied (all feature entrypoints execute in order)
3. Users can opt into specific behavior via CLI flags

### Validation

The entrypoint merger validates configurations and provides clear error messages:

```bash
# Multiple features with entrypoints - allowed, wrapped in order
✓ Feature 'node' defines entrypoint: /usr/local/share/nvm/init.sh
✓ Feature 'python' defines entrypoint: /usr/local/share/python/init.sh
→ Using wrap strategy: node → python → base

# Compose entrypoint present - always wins
✓ Compose service 'app' defines entrypoint: /docker-entrypoint.sh
→ Using compose entrypoint (ignoring feature entrypoints)
```

## Configuration Examples

### Compose with Feature Entrypoint

```yaml
# docker-compose.yml
services:
  app:
    image: ubuntu:22.04
    entrypoint: /custom-entrypoint.sh  # Takes precedence
```

```json
// devcontainer.json
{
  "dockerComposeFile": "docker-compose.yml",
  "service": "app",
  "features": {
    "ghcr.io/devcontainers/features/node:1": {
      "entrypoint": "/usr/local/share/nvm/init.sh"  // Ignored
    }
  }
}
```

Result: Only `/custom-entrypoint.sh` is used.

### Multiple Features with Wrap

```json
// devcontainer.json
{
  "image": "ubuntu:22.04",
  "features": {
    "ghcr.io/devcontainers/features/node:1": {
      "entrypoint": "/usr/local/share/nvm/init.sh"
    },
    "ghcr.io/devcontainers/features/python:1": {
      "entrypoint": "/usr/local/share/python/init.sh"
    }
  }
}
```

Result: Wrapper script invokes both feature entrypoints, then base.

### Override Strategy via CLI

```bash
# Ignore feature entrypoints
deacon up --feature-entrypoint=ignore

# Replace base with feature entrypoint
deacon up --feature-entrypoint=replace
```

## Implementation Details

The entrypoint merge logic is implemented in `crates/core/src/entrypoint.rs`:

- `EntrypointMergeStrategy`: Enum defining merge strategies
- `EntrypointMerger`: Main merger implementation with validation
- `MergedEntrypoint`: Result structure with entrypoint and optional wrapper path

Key functions:
- `merge_entrypoints()`: Merges entrypoints from various sources
- `generate_wrapper_script()`: Creates wrapper shell script
- `validate_merge()`: Validates merge for conflicts

## Testing

The implementation includes comprehensive test coverage:

### Unit Tests (13 tests)
- Compose precedence verification
- Strategy behavior testing
- Wrapper script generation
- Validation logic

### Integration Tests (11 tests)
- Real-world scenarios with compose and features
- Multi-feature ordering verification
- Script structure validation
- Error handling verification

Run tests:
```bash
cargo test --lib entrypoint
cargo test --test integration_entrypoint_compose
```

## Future Enhancements

Potential improvements for future versions:

1. **Async wrapper support**: Support for async initialization in feature entrypoints
2. **Timeout handling**: Configurable timeouts for feature entrypoint execution
3. **Parallel execution**: Allow independent features to run entrypoints in parallel
4. **Conditional execution**: Skip feature entrypoints based on environment conditions
5. **Debugging mode**: Enhanced logging and debugging support for wrapper scripts

## References

- [DevContainer Specification - Features](https://containers.dev/implementors/features/)
- [Docker Compose - Entrypoint](https://docs.docker.com/compose/compose-file/05-services/#entrypoint)
- [CLI-SPEC.md - Feature System](../CLI-SPEC.md#feature-system)
- [CLI-SPEC.md - Docker Integration](../CLI-SPEC.md#docker-integration)
