#![cfg(feature = "full")]
//! Integration tests for vulnerability scan functionality

use assert_cmd::Command;
use predicates::prelude::*;
use std::env;
use tempfile::TempDir;

#[test]
fn test_cli_scan_flags_parsing() {
    // Test that CLI flags are parsed correctly
    let mut cmd = Command::cargo_bin("deacon").unwrap();
    let output = cmd.arg("build").arg("--help").assert().success();

    let output_str = String::from_utf8_lossy(&output.get_output().stdout);
    assert!(output_str.contains("--scan-image"));
    assert!(output_str.contains("--fail-on-scan"));
}

#[test]
fn test_scan_without_docker_env_var() {
    // Create a temporary directory with a simple test setup
    let temp_dir = TempDir::new().unwrap();

    // Create a minimal devcontainer.json - this will fail to build but allows testing argument parsing
    let devcontainer_config = r#"{
    "name": "Test Container", 
    "image": "alpine:3.19"
}
"#;

    std::fs::create_dir(temp_dir.path().join(".devcontainer")).unwrap();
    std::fs::write(
        temp_dir.path().join(".devcontainer/devcontainer.json"),
        devcontainer_config,
    )
    .unwrap();

    // Ensure DEACON_SCAN_CMD is not set
    env::remove_var("DEACON_SCAN_CMD");

    // Test build command with scan flags. Image reference builds are now supported,
    // so the build may succeed even without a scan command. We validate that:
    // 1. Flags are accepted (no clap parsing failure / exit code 2)
    // 2. A warning is emitted about the missing DEACON_SCAN_CMD.
    let mut cmd = Command::cargo_bin("deacon").unwrap();
    cmd.current_dir(&temp_dir)
        .arg("build")
        .arg("--scan-image")
        .arg("--fail-on-scan");
    let assert = cmd.assert();

    let output = assert.get_output();
    // Build may succeed (image reference build path). Either way we must not have an argument parsing error.
    assert_ne!(
        output.status.code(),
        Some(2),
        "Unexpected clap parsing failure (exit code 2)"
    );
    // Ensure the warning about skipping scan is present (stderr logging).
    let stderr = String::from_utf8_lossy(&output.stderr);
    assert!(
        stderr.contains("DEACON_SCAN_CMD environment variable not set"),
        "Expected warning about missing scan command, got: {}",
        stderr
    );
}

#[test]
fn test_fail_on_scan_requires_scan_image() {
    // Test that --fail-on-scan requires --scan-image
    let mut cmd = Command::cargo_bin("deacon").unwrap();
    cmd.arg("build").arg("--fail-on-scan");

    cmd.assert()
        .failure()
        .code(2) // clap uses exit code 2 for argument parsing failures
        .stderr(predicate::str::contains("--scan-image"));
}

/// Test token substitution function directly via unit tests
#[cfg(test)]
mod unit_tests {
    use deacon::commands::build::substitute_tokens;

    #[test]
    fn test_token_substitution_direct() {
        let template = "trivy image {image}";
        let image_id = "sha256:abc123def456";
        let result = substitute_tokens(template, image_id).unwrap();
        assert_eq!(result, "trivy image sha256:abc123def456");

        // Test with multiple occurrences
        let template = "scanner --image {image} --output /tmp/{image}.json";
        let result = substitute_tokens(template, image_id).unwrap();
        assert_eq!(
            result,
            "scanner --image sha256:abc123def456 --output /tmp/sha256:abc123def456.json"
        );
    }
}
