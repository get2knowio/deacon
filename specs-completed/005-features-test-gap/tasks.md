---

description: "Task list to close gaps in 'features test' per SPEC"

---

# Tasks: Features Test GAP Closure

**Input**: Design documents from `/specs/005-features-test-gap/`
**Prerequisites**: plan.md (required), spec.md (required), research.md, data-model.md, contracts/

**Tests**: Tests are OPTIONAL in this plan (per template rules). Acceptance criteria and independent test checks are provided for each story.

**Organization**: Tasks are grouped by user story to enable independent implementation and testing of each story.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Include exact file paths in descriptions

## Path Conventions

- Single project Rust workspace: `crates/deacon/` (CLI entrypoint), `crates/core/` (shared logic)
- Specs and docs for this feature live under `specs/005-features-test-gap/`

---

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Establish core module skeleton and types for the `features test` workflow

- [X] T001 Create module skeleton `crates/core/src/features_test/mod.rs`
- [X] T002 [P] Add data model definitions per spec to `crates/core/src/features_test/model.rs`
- [X] T003 [P] Create discovery module `crates/core/src/features_test/discovery.rs` ‚Äî **COMPLETED**: Full implementation with `discover_test_collection`, `discover_features`, and `discover_scenarios` functions; supports JSON and JSONC formats with detailed error messages
- [X] T004 [P] Create runner module `crates/core/src/features_test/runner.rs` ‚Äî **COMPLETED**: Full implementation with `execute_autogenerated_test`, `execute_scenario_test`, and `execute_duplicate_test` functions; includes container lifecycle management, script execution, and labeled cleanup support
- [X] T005 [P] Create error enum and mapping in `crates/core/src/features_test/errors.rs` ‚Äî **COMPLETED**: All error variants including `CollectionNotFound` are present and properly mapped

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Wire CLI flags and output contracts; provide entrypoint and validations

**‚ö†Ô∏è CRITICAL**: No user story work can begin until this phase is complete

- [X] T006 Update `FeatureCommands::Test` flags in `crates/deacon/src/cli.rs` (project-folder, features, filter, global-scenarios-only, skip-scenarios, skip-autogenerated, skip-duplicated, permit-randomization, base-image, remote-user, preserve-test-containers, quiet, log-level, json)
- [X] T007 [P] Add argument validation for invalid combinations in `crates/deacon/src/commands/features.rs` (mutual exclusivity and requires rules)
- [X] T008 [P] Add collection entrypoint `execute_features_test_collection(...)` in `crates/deacon/src/commands/features.rs` ‚Äî **COMPLETED**: Function fully wired with discovery and runner modules; includes _global scenarios handling, cleanup, and zero-tests support
- [X] T009 [P] Implement strict JSON output `[ { "testName": string, "result": boolean } ]` in `crates/deacon/src/commands/features.rs` (stdout array; logs to stderr) ‚Äî **COMPLETED**: JSON output properly outputs array to stdout; zero-tests case returns empty array `[]`
// Randomization flag status and behavior
- [X] T034 [Foundational] Decide and enforce `--permit-randomization` behavior ‚Äî **COMPLETED**: Returns "Not implemented yet: randomization" error message when flag is provided (Constitution III compliance); maintains deterministic order by default
   - Option (defer, recommended now): Emit a clear "Not implemented yet: randomization" error when the flag is provided (Constitution III compliance); maintain deterministic order by default
   - Files: `crates/deacon/src/cli.rs`, `crates/deacon/src/commands/features.rs`
   - Tests: `crates/deacon/tests/integration_features_test.rs` case asserting explicit error on use of the flag

---

## Phase 3: User Story 1 - Run a complete features test suite (Priority: P1) üéØ MVP

**Goal**: Discover features and scenarios in a collection and execute autogenerated, scenario, and duplicate/idempotence tests with a clear per-test summary and overall status.

**Independent Test**: Given a valid collection (`src/` + `test/`), run with default options. Verify all selected autogenerated tests, scenarios, and duplicate checks execute; `_global` scenarios included only when no `--features` provided; exit code reflects overall pass/fail.

### Implementation for User Story 1

- [X] T010 [P] [US1] Implement TestCollection discovery (`src/`, `test/` presence) in `crates/core/src/features_test/discovery.rs` ‚Äî **COMPLETED**: Full implementation with validation of root_path existence, src/ and test/ directory presence checks, appropriate error handling (CollectionNotFound, MissingDirectory), and TestCollection creation with proper ID and paths
- [X] T011 [P] [US1] Implement feature and scenario enumeration with case-sensitive name filtering in `crates/core/src/features_test/discovery.rs` ‚Äî **COMPLETED**: Added `filter_features` and `filter_scenarios` helper functions with case-sensitive filtering; features are filtered by ID, scenarios by name substring match
- [X] T012 [US1] Implement autogenerated test executor using container runtime helpers in `crates/core/src/features_test/runner.rs` ‚Äî **COMPLETED**: Full implementation in runner.rs:23-70; creates container, copies test.sh, executes script, cleans up unless preserve flag set
- [X] T013 [US1] Implement duplicate/idempotence test executor per feature in `crates/core/src/features_test/runner.rs` ‚Äî **COMPLETED**: Full implementation in runner.rs:84-152; runs install.sh twice in same container to verify idempotence
- [X] T014 [US1] Aggregate `TestResult[]` and compute overall status in `crates/deacon/src/commands/features.rs` ‚Äî **COMPLETED**: Full implementation at lines 774-845; executes autogenerated, duplicate, and scenario tests; aggregates results; outputs text summary or JSON array; sets exit code based on pass/fail

**Checkpoint**: User Story 1 fully functional; JSON/text output contracts respected; runs serially.

---

## Phase 4: User Story 2 - Control scope and behavior via flags (Priority: P1)

**Goal**: Precisely select features/scenarios and control cleanup/output to support deterministic CI runs.

**Independent Test**: Exercise flags: `--project-folder`, `--features`, `--filter`, `--global-scenarios-only`, `--skip-*`, `--base-image`, `--remote-user`, `--preserve-test-containers`, `--quiet`. Validate selection, filtering, cleanup, and zero-tests behavior.

### Implementation for User Story 2

- [X] T015 [P] [US2] Enforce selection semantics for `--features` vs `_global` in `crates/deacon/src/commands/features.rs` ‚Äî **COMPLETED**: Implementation at lines 726-762; _global scenarios included when no --features provided OR --global-scenarios-only set
- [X] T016 [P] [US2] Enforce invalid combinations (`--skip-scenarios` with `--filter`/`--global-scenarios-only`) in `crates/deacon/src/commands/features.rs` ‚Äî **COMPLETED**: Validation at lines 674-686; rejects mutually exclusive flag combinations with clear error messages
- [X] T017 [P] [US2] Implement labeled cleanup and `--preserve-test-containers` in `crates/core/src/features_test/runner.rs` ‚Äî **COMPLETED**: Containers labeled with devcontainer.is_test_run=true; cleanup_all_test_containers() removes labeled containers; --preserve flag honored at commands/features.rs:804-811
- [X] T018 [US2] Honor `--base-image` and `--remote-user` in container exec in `crates/core/src/features_test/runner.rs` ‚Äî **COMPLETED**: Base image passed to create_test_container(); remote_user passed to execute_script_in_container(); default "ubuntu:focal" applied at commands/features.rs:711
- [X] T019 [US2] Implement `--quiet`/`--log-level` handling for this subcommand in `crates/deacon/src/commands/features.rs` ‚Äî **COMPLETED**: log_level converted from CliLogLevel to CoreLogLevel at lines 715-719; quiet flag passed through TestRun and used in cleanup warning at line 808
// Enforce duplicate policy and zero-tests behavior; default base image
- [X] T029 [US2] Enforce duplicate/idempotence disabled in `--global-scenarios-only` ‚Äî **COMPLETED**: Implementation at commands/features.rs:788; duplicate tests skip when global_only is true
   - Files: `crates/deacon/src/commands/features.rs` (scheduler), `crates/core/src/features_test/runner.rs` (defensive assert)
   - Tests: `crates/deacon/tests/integration_features_test.rs` confirms no duplicate checks run in global-only mode (both text and `--json`)
- [X] T031 [US2] Explicit zero-tests branch (text + JSON) ‚Äî **COMPLETED**: Implementation at commands/features.rs:814-821; exits 0 with "No tests found" in text mode; outputs "[]" in JSON mode
   - Files: `crates/deacon/src/commands/features.rs` ‚Äî when selection/filter yields zero tests, print "No tests found" (text mode) and exit 0; with `--json`, stdout is exactly `[]`
   - Tests: `crates/deacon/tests/integration_features_test.rs` asserts text summary and exact JSON array
- [X] T032 [US2] Default base image when `--base-image` is absent ‚Äî **COMPLETED**: Implementation at commands/features.rs:711; defaults to "ubuntu:focal" when base_image is None
   - Files: `crates/core/src/features_test/runner.rs` ‚Äî default to `ubuntu:focal` unless overridden; honor `--remote-user`
   - Tests: `crates/core/tests/features_test_runner.rs` validates default and override semantics

**Checkpoint**: User Stories 1 and 2 independently usable; CI-friendly behavior established.

---

## Phase 5: User Story 3 - Clear failures and validations (Priority: P2)

**Goal**: Fast, actionable failures for missing structure, scripts, malformed scenarios, and runtime errors; no silent fallbacks.

**Independent Test**: Intentionally run with missing `src/`/`test/`, missing `test.sh`, malformed `scenarios.json(c)`, invalid flag combos, or no container runtime. Expect clear errors and non-zero exit.

### Implementation for User Story 3

- [X] T020 [P] [US3] Validate structure: error when `src/` or `test/` missing in `crates/core/src/features_test/discovery.rs`
- [X] T021 [P] [US3] Validate missing `test/<feature>/test.sh` when autogenerated tests enabled in `crates/core/src/features_test/discovery.rs` ‚Äî **COMPLETED**
- [X] T022 [P] [US3] Parse scenario definitions (`scenarios.json`/JSONC) and surface parse errors in `crates/core/src/features_test/discovery.rs`
- [X] T023 [US3] Propagate runtime unavailability as a clear error (non-zero) in `crates/core/src/features_test/runner.rs`
// Cross-platform and scenario schema clarifications
- [X] T030 [P] [US3] Cross-platform path normalization & discovery consistency ‚Äî **COMPLETED**: Added explicit comments documenting cross-platform path handling in discovery.rs; `std::path::Path` and `PathBuf` automatically normalize separators; `file_name()` extracts directory names without separators; `canonicalize()` produces normalized absolute paths
   - Files: `crates/core/src/features_test/discovery.rs` ‚Äî normalize path separators, maintain case-sensitive discovery, support spaces in paths and feature IDs
   - Tests: `crates/core/tests/features_test_paths.rs` for normalization and discovery with mixed separators and spaces
- [X] T033 [P] [US3] Pin scenario file location & minimal schema + validation ‚Äî **COMPLETED**: Documentation updated to explicitly state scenarios MUST be at `test/<feature>/scenarios.json` or `.jsonc`; parse errors include file path and line/column info (via json5::Error); comprehensive test suite added covering valid/invalid JSON/JSONC, missing files, empty files, malformed schemas, and all edge cases
   - Files: `crates/core/src/features_test/discovery.rs` ‚Äî load `test/<feature>/scenarios.json` or `.jsonc`; on parse error, include file path (and line/col when available)
   - Tests: `crates/core/tests/features_test_scenarios.rs` for valid/invalid JSONC and missing file behavior

**Checkpoint**: All user stories independently functional with robust validations.

---

## Phase N: Polish & Cross-Cutting Concerns

**Purpose**: Hardening, docs, and observability

- [X] T024 [P] Update subcommand help and SPEC notes in `docs/subcommand-specs/features-test/SPEC.md` (flags and output examples)
- [X] T025 [P] Update feature quickstart example in `specs/005-features-test-gap/quickstart.md` (JSON mode, zero-tests behavior)
- [X] T026 Add tracing spans (`feature.test`, `scenario.run`, `cleanup`) in `crates/core/src/features_test/runner.rs` ‚Äî **COMPLETED**: Added structured tracing spans with fields (feature_id, test_type, scenario_name, base_image, container_id) to execute_autogenerated_test, execute_duplicate_test, execute_scenario_test, and cleanup_container functions
- [X] T027 [P] Add rustdoc for public types and functions in `crates/core/src/features_test/*.rs` ‚Äî **COMPLETED**: Module-level docs and comprehensive rustdoc with examples added to all public APIs in mod.rs, model.rs, errors.rs, discovery.rs, and runner.rs
- [X] T028 Run fmt and clippy; fix warnings in `crates/**` (workspace-wide)
// Consistent wording in docs and user messages
- [X] T035 [P] Normalize terminology to "duplicate/idempotence" across docs and user-facing output ‚Äî **COMPLETED**: Unified terminology to "duplicate/idempotence" across all documentation, user-facing output, and test result names; code identifiers (function/variable names) remain unchanged per requirements
   - Files: `docs/subcommand-specs/features-test/SPEC.md`, `specs/005-features-test-gap/spec.md`, and any user messages in `crates/deacon`/`crates/core`
   - Acceptance: No mixed variants ("duplicate", "idempotence", "duplicate/idempotence") remain; prefer the unified term

---

## Dependencies & Execution Order

### Phase Dependencies

- Setup (Phase 1): No dependencies
- Foundational (Phase 2): Depends on Setup completion ‚Äî BLOCKS all user stories
- User Stories (Phase 3+): Depend on Foundational; US1 and US2 are both P1 and can proceed in parallel after Phase 2
- Polish (Final): Depends on selected user stories being complete

### User Story Dependencies

- User Story 1 (P1): No dependency on other stories; starts after Phase 2
- User Story 2 (P1): Independent of US1; starts after Phase 2
- User Story 3 (P2): Starts after Phase 2; independent of US1/US2 implementation (validations are orthogonal)

### Within Each User Story

- Discovery (enumeration) before execution
- Execution before aggregation/output
- Validations applied pre-execution where applicable

### Parallel Opportunities

- Phase 1 files T002‚ÄìT005 can be created in parallel
- Phase 2 tasks T007‚ÄìT009 can be implemented in parallel with T006 finalized
- US1: T010 and T011 can be parallelized; T012/T013 can proceed once discovery scaffolds compile; T014 after executors
- US2: T015‚ÄìT017 can proceed in parallel; T018 then T019
- US3: T020‚ÄìT022 in parallel; T023 after runner wiring

---

## Parallel Example: User Story 1

```bash
# Parallelizable discovery work
Task: "T010 [US1] Implement TestCollection discovery in crates/core/src/features_test/discovery.rs"
Task: "T011 [US1] Implement feature and scenario enumeration with filtering in crates/core/src/features_test/discovery.rs"

# Then parallelize executors
Task: "T012 [US1] Autogenerated test executor in crates/core/src/features_test/runner.rs"
Task: "T013 [US1] Duplicate/idempotence executor in crates/core/src/features_test/runner.rs"
```

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. Complete Phase 1: Setup
2. Complete Phase 2: Foundational
3. Complete Phase 3: User Story 1
4. STOP and validate: JSON array output contract; serial execution; summary in text mode

### Incremental Delivery

1. Setup + Foundational ‚Üí Foundation ready
2. Add US1 ‚Üí Validate independently ‚Üí Demo (MVP)
3. Add US2 ‚Üí Validate independently ‚Üí Demo
4. Add US3 ‚Üí Validate independently ‚Üí Demo

### Parallel Team Strategy

1. Team completes Setup + Foundational together
2. After Phase 2:
   - Developer A: US1 discovery/execution
   - Developer B: US2 flag semantics/cleanup
   - Developer C: US3 validations and error paths

---

## Notes

- [P] tasks = different files, no dependencies
- [Story] label maps task to specific user story for traceability
- Each user story is independently completable and testable per acceptance criteria in `spec.md`
- In JSON mode, stdout must contain only `TestResult[]` (strict) and logs must go to stderr
