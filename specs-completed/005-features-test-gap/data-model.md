# Data Model: Features Test

This model defines entities, fields, relationships, and validation rules for the `features test` workflow.

## Entities

### TestCollection
- id: string (path hash or absolute path; not persisted)
- rootPath: string (absolute path to collection)
- srcPath: string (absolute path `${root}/src`)
- testPath: string (absolute path `${root}/test`)

Validation:
- Must contain `src/` and `test/` folders.

### Feature
- id: string (feature folder name)
- srcDir: string (absolute path `${srcPath}/${id}`)
- testDir: string (absolute path `${testPath}/${id}`)
- hasAutogenerated: boolean (true if `${testDir}/test.sh` exists)
- scenarios: Scenario[]

Relationships:
- Feature belongs to TestCollection; has many Scenarios.

### Scenario
- featureId: string (or `_global`)
- name: string (display name)
- scriptPath: string (absolute path to scenario script)
- configPath: string | null (optional scenario JSONC path if applicable)

Validation:
- The script must exist and be executable by the container runtime.

### TestResult
- testName: string (feature name, `feature (duplicate/idempotence)`, or `feature:scenario`)
- result: boolean (pass = true; fail = false)

### TestRun
- selectedFeatures: string[] | null
- filter: string | null (case-sensitive substring on Scenario.name)
- globalOnly: boolean
- skipScenarios: boolean
- skipAutogenerated: boolean
- skipDuplicated: boolean
- permitRandomization: boolean
- baseImage: string (default `ubuntu:focal`)
- remoteUser: string | null
- preserve: boolean
- quiet: boolean
- logLevel: enum { info, debug, trace }

Derived:
- effectiveFeatures(TestCollection, selectedFeatures, globalOnly) -> Feature[]
- effectiveScenarios(Feature|_global, filter, skipScenarios) -> Scenario[]

## State Transitions

1. ParsedInput -> TestRun: CLI parsing and validation (mutual exclusivity and structure checks).
2. TestRun -> Discovery: Determine features and scenarios based on flags.
3. Discovery -> Execution: Run autogenerated tests, scenarios, and duplicates (as configured).
4. Execution -> Aggregation: Collect TestResult[] and compute overall pass/fail.

## Invariants

- In `globalOnly`, duplicate/idempotence tests DO NOT run.
- In JSON mode, stdout contains only `TestResult[]` and nothing else.
- If zero tests discovered post-filtering, exit 0; JSON mode emits `[]`.

## Errors

- Invalid flag combinations: argument error before execution.
- Missing `src/` or `test/`: validation error, exit non-zero.
- Missing `test.sh` when autogenerated enabled for a feature: validation error.
- Scenario parse errors: list errors then exit non-zero.
