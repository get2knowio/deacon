- [x] Prompt: **Medium** — Data model deviates from spec map shape and null field requirements (`crates/core/src/outdated.rs:12-44` vs `specs/009-outdated-subcommand/data-model.md:17-25`). Rationale: `OutdatedResult` uses a `Vec` and222 `FeatureVersionInfo` skips serializing `None`, conflicting with the defined `map<string, FeatureVersionInfo>` where keys must exist and unknowns are null (FR‑003). Fix: reshape `OutdatedResult` to a map keyed by canonical IDs and ensure serializers emit all fields with nulls rather than dropping them; update usages and docs to stay consistent.
- [x] Prompt: **High** — Align wanted/current derivation with spec for non‑semver tags and digests (`crates/core/src/outdated.rs:72-126`). Rationale: spec wanted rules (`docs/subcommand-specs/outdated/SPEC.md:114-136`, `specs/009-outdated-subcommand/spec.md:104-113`) expect semver-normalized tags, `latest` resolved/null, and digest cases to avoid carrying pseudo-version strings; current code returns literal tags like `"latest"` and leaves digest wanted/current empty, breaking comparison and majors. Fix: implement the spec algorithm (normalize/validate tags, treat non-semver as null, resolve `latest` via tag listing when available, fall back to lockfile/metadata for digests) and update `derive_current_version` and tests accordingly.
- [x] Prompt: **High** — Rework `fetch_latest_stable_version` to return a typed `Result` with a `FetchError` enum rather than swallowing errors (`crates/core/src/outdated.rs:128-186`). Factor parsing and tag selection into helpers, propagate errors from the fetcher/list_tags paths, and return `Ok(Some/None)` on success.
- [x] Prompt: **Low** — Deduplicate `latest_major` logic by delegating to `wanted_major` or a shared helper so the major-selection rules live in one place (`crates/core/src/outdated.rs:188-193`).
- [x] Prompt: **Medium** — Address the refactor suggestion spanning the outdated command (`crates/deacon/src/commands/outdated.rs:83-353`); review this region for structural cleanup per CodeRabbit and apply the recommended refactor.
- [x] Prompt: **High** — Remove unwraps when extracting `features_map` and handle the empty-features branch with pattern matching (`crates/deacon/src/commands/outdated.rs:118-146`), reusing the bound map in subsequent logic.
- [x] Prompt: **High** — Honor `--fail-on-outdated` in text mode (`crates/deacon/src/commands/outdated.rs:270-350`). Rationale: spec FR‑011/FR‑013 (`specs/009-outdated-subcommand/spec.md:82-94`) requires exit code 2 whenever any feature is outdated regardless of output; current logic only gates JSON, so text runs always return 0. Fix: evaluate outdated conditions on the aggregated results before emitting text and return `OutdatedExitCode(2)` while still printing the report.
- [x] [P] Prompt: **Medium** — Swap the deprecated `atty` usage for `is-terminal` in outdated command IO detection (`crates/deacon/src/commands/outdated.rs:6,135,307`), importing `IsTerminal` and using `.is_terminal()` on std handles.
- [x] [P] Prompt: **High** — Respect explicit config paths for `outdated` (`crates/deacon/src/commands/outdated.rs:86-115`). Rationale: CLI contract in `docs/subcommand-specs/outdated/SPEC.md:18-41` allows `--config`/override to control the effective file; current implementation always auto-discovers, ignoring `Cli` globals, so users cannot target alternate configs. Fix: thread `config`/`override_config` from `Cli` into `OutdatedArgs`, resolve precedence, and load via `ConfigLoader` honoring overrides with appropriate error messages.
- [x] [P] Prompt: **High** — Replace the direct `std::process::exit` in the special exit-code branch with a Termination-returning wrapper (`crates/deacon/src/main.rs:17-21`). Implement a wrapper (or `Termination` for `OutdatedExitCode`) that converts the stored code via an `exit_code()` accessor and implements `Display`, then return `Err(wrapper)` from `main` to allow normal cleanup; note in a short comment why the special exit handling exists.
- [x] [P] Prompt: **Low** — Simplify `clap` command dispatch by returning the `run_outdated` future directly instead of matching on `Err(e)` and re-returning it (`crates/deacon/src/cli.rs:1297-1308`).
- [x] Prompt: **Medium** — Spec-mandated tests are missing for the new subcommand (`specs/009-outdated-subcommand/tasks.md:150-163`). Rationale: text/JSON rendering, `--fail-on-outdated` exit 2, resilience, doctests, and perf/mocking checks are not implemented, leaving core behaviors unverified and risking regressions against FR-001–FR-013. Fix: add the listed unit/integration/performance tests using mocked registries (no network), cover exit codes and formatting, and enable doctests for published helpers.
- [x] Prompt: **High** — The outdated command loads only the top-level file via `ConfigLoader::load_from_path` (`crates/deacon/src/commands/outdated.rs:92-141`), so any Features brought in through `extends`/override chains never appear in the report, contradicting the spec’s configuration-resolution step (`docs/subcommand-specs/outdated/SPEC.md:60-86`). Fix: switch to `ConfigLoader::load_with_extends` (or the same resolution path used by `read-configuration`) so the effective configuration—including inherited features and variable substitution—is analyzed before iterating `config.features`.
- [x] Prompt: **Medium** — Legacy/local feature identifiers are not skipped before fetching tags (`crates/deacon/src/commands/outdated.rs:158-205`), violating the contract that invalid/unsupported refs are omitted (`docs/subcommand-specs/outdated/SPEC.md:224-239`). Rationale: entries like `./local-feature` or `https://example.com/...` are still pushed into `declared_refs`, leading to bogus rows in the report and futile OCI requests against nonsense registries (timeouts/confusing warnings). Fix: introduce a `parse_feature_ref` helper (reuse `deacon_core::oci::FeatureRef` parsing) that returns `None` for non-OCI schemes and skip those entries entirely, matching the spec’s “skip, don’t fail” guidance.
- [x] Prompt: **Medium** — JSON output silently reorders features alphabetically (`crates/deacon/src/commands/outdated.rs:267-302`) even though the spec requires declaration order to be preserved (`docs/subcommand-specs/outdated/SPEC.md:139-148,270-276`). Rationale: building the JSON payload with a `BTreeMap` sorts keys lexicographically, so consumers no longer see the config order promised in FR-001 and SC-001; the existing integration test (`crates/deacon/tests/integration_outdated_json.rs:59-103`) even codifies this incorrect behavior. Fix: keep the ordered `Vec<FeatureVersionInfo>` (or an `IndexMap`) when serializing so insertion order matches the config, and update the test to assert exact ordering instead of just key presence.
- [x] [P] Prompt: **Medium** — Compose definition in `fixtures/devcontainer-up/compose-with-profiles/docker-compose.yml:1` still uses schema `3.8`, which lacks profile support. Update the version string to `3.9` or later so the profiles referenced in this file work with the spec’s expectations, and verify downstream tooling accepts the bumped value.
- [x] [P] Prompt: **Medium** — Service image in `fixtures/devcontainer-up/compose-with-profiles/docker-compose.yml:15` currently uses `alpine:latest`, leading to non-reproducible builds. Pin this service to a stable tag such as `alpine:3.18` (or `3.19`) and adjust any docs/CI that may rely on the change.
- [x] [P] Prompt: **Low** — The comment above `pub use crate::commands::up::UpResult` in `crates/deacon/src/commands/mod.rs:17-18` is a plain comment that inaccurately references “types”. Replace it with a concise rustdoc `/// Re-export the UpResult type to preserve the stdout JSON contract for the up command.` so the documentation matches the actual export.
- [x] [P] Prompt: **Medium** — `UpArgs` in `crates/deacon/tests/integration_host_requirements.rs:127-132` lacks the `ignore_host_requirements` flag promised by the test name, keeping the scenario from exercising the intended branch. Add `ignore_host_requirements: true` (or restore the setter) to the `UpArgs` construction so the test truly covers the ignored-with-flag behavior.
- [x] [P] Prompt: **Low** — `crates/deacon/tests/up_json_output.rs:30-40` calls `Command::cargo_bin("deacon").unwrap()`, which panics without context on failure. Replace `unwrap()` with `expect("failed to find deacon binary for tests")` (or similar) so the test communicates why a missing binary indicates a setup issue rather than an opaque panic.
