# Implementation Plan: Features Publish Spec Compliance

**Branch**: `003-features-publish-compliance` | **Date**: 2025-11-01 | **Spec**: `/workspaces/003-features-publish-cmd/docs/subcommand-specs/features-publish/SPEC.md`
**Input**: Feature specification from `/workspaces/003-features-publish-cmd/specs/003-features-publish-compliance/spec.md`

**Note**: This plan is generated by the speckit plan workflow and will guide implementation to full spec parity.

## Summary

Close gaps in the `features publish` subcommand to match the spec: add `--namespace` (separate from `--registry`), compute semantic tags for a version (`X`, `X.Y`, `X.Y.Z`, and `latest` for stable), list existing tags to ensure idempotency, publish collection metadata, support registry auth, and emit a structured JSON result with published vs. skipped tags and totals.

## Technical Context

**Language/Version**: Rust (Edition 2021), workspace rust-version 1.70, stable toolchain (rustfmt, clippy)
**Primary Dependencies**: clap (CLI), serde/serde_json (I/O), tracing (logs), thiserror (errors), tokio (async), reqwest (HTTP, rustls TLS), semver (versioning)
**Storage**: N/A (OCI registry as remote store)
**Testing**: cargo test; assert_cmd for CLI E2E; tokio-test/wiremock for HTTP; doctests on public APIs
**Target Platform**: Cross-platform CLI (Linux primary); OS-agnostic registry interactions
**Project Type**: Rust workspace with binary crate (`crates/deacon`) and core library (`crates/core`)
**Performance Goals**: Re-publish idempotent path completes < 10s locally (SC2); network-bound first publishes
**Constraints**: JSON mode prints a single JSON document to stdout; logs to stderr; no network in unit tests; fail fast if capabilities unimplemented
**Scale/Scope**: Single CLI subcommand plus core OCI client enhancements; moderate test additions; no new crates

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- I. Spec‑Parity as Source of Truth: Aligned to `docs/subcommand-specs/features-publish/SPEC.md` and `docs/CLI-SPEC.md`. Examples/tests will be updated alongside behavior. PASS
- II. Keep the Build Green: Fast loop (fmt, clippy, unit/doctests) during iteration; full gate before PR. No code changes yet; plan complies. PASS
- III. No Silent Fallbacks — Fail Fast: Publish will error clearly when OCI auth/resolution is unavailable; no stubbed behavior in production. PASS
- IV. Idiomatic, Safe Rust: No `unsafe`. Introduce trait-centric updates to OCI client; async only for HTTP/FS. PASS
- V. Observability & Output Contracts: JSON mode emits only the single JSON object on stdout; logs (with redaction) to stderr via `tracing`. PASS (to be validated during implementation)

## Project Structure

### Documentation (this feature)

```text
specs/003-features-publish-compliance/
├── plan.md              # This file (current)
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
└── contracts/           # Phase 1 output (schemas for outputs)
```

### Source Code (repository root)

```text
crates/
├── deacon/
│   └── src/
│       ├── cli.rs                      # Add --namespace, --log-level
│       └── commands/
│           └── features.rs             # Orchestrate publish flow, JSON output
└── core/
    └── src/
        └── oci.rs                      # Tag listing, auth, collection publish

crates/deacon/tests/
└── integration_features_publish.rs     # New integration tests per spec
```

**Structure Decision**: Extend existing Rust workspace: enhance CLI argument parsing and core OCI client; add targeted integration tests under `crates/deacon/tests/` reflecting spec scenarios.

## Complexity Tracking

No constitution violations anticipated. If registry auth support necessitates additional adapters, justify under this section during implementation.
