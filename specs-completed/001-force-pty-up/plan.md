# Implementation Plan: Force PTY toggle for up lifecycle

**Branch**: `001-force-pty-up` | **Date**: 2025-11-26 | **Spec**: /workspaces/deacon/specs/001-force-pty-up/spec.md  
**Input**: Feature specification from `/specs/001-force-pty-up/spec.md`

## Summary

Force PTY allocation for `deacon up` lifecycle exec when JSON logs are active and the PTY toggle is set via flag or `DEACON_FORCE_TTY_IF_JSON`, while keeping non-PTY defaults when unset and leaving other exec paths unchanged. Approach: resolve PTY preference with flag > env > default (no PTY), apply only in JSON log mode, preserve stdout/stderr separation, and add integration coverage for PTY-on/off plus exec regression.

## Technical Context

**Language/Version**: Rust (2021 edition; workspace pinned via rust-toolchain)  
**Primary Dependencies**: clap, serde/serde_json, tracing, anyhow/thiserror, tokio, existing exec/TTY helpers in crates/core and crates/deacon  
**Storage**: N/A (CLI runtime only)  
**Testing**: `cargo fmt --all`, `cargo fmt --all -- --check`, `cargo clippy --all-targets -- -D warnings`, `make test-nextest-fast` (expand to other nextest targets as needed)  
**Target Platform**: Linux CLI (devcontainer/runtime hosts)  
**Project Type**: CLI workspace (Rust)  
**Performance Goals**: No measurable regression to `up` lifecycle exec; PTY resolution adds negligible overhead  
**Constraints**: Preserve stdout/stderr separation (JSON logs to stderr, outputs to stdout), follow spec parity for flag/env precedence, no silent fallbacks on PTY failure  
**Scale/Scope**: Single CLI workflow (`deacon up` lifecycle exec) affecting PTY behavior; other exec entry points unchanged

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- Spec-parity: Honor CLI spec and PTY/log contracts; no divergence without spec updates. **Status: PASS**  
- No silent fallbacks: PTY allocation failures must surface errors, not downgrade quietly. **Status: PASS**  
- Stdout/stderr separation: JSON outputs on stdout; logs/diagnostics on stderr even under PTY. **Status: PASS**  
- Testing standard: Use nextest targets, fmt, clippy; fix failures rather than skipping. **Status: PASS**  
- Idiomatic Rust: No `unsafe`, use existing error handling patterns. **Status: PASS**  
- Examples alignment: If examples touched, ensure exec.sh/README stay in sync. **Status: PASS**
- Post-design check: After research/data-model/contracts creation, no new violations identified. **Status: PASS**

## Project Structure

### Documentation (this feature)

```text
specs/001-force-pty-up/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
└── tasks.md (to be generated by /speckit.tasks)
```

### Source Code (repository root)

```text
crates/
├── core/        # shared models/helpers
└── deacon/      # CLI binary and workflows (up/exec)
docs/            # specs and CLI documentation
examples/        # runnable examples + exec.sh scripts
fixtures/        # test fixtures
tests/ (within crates/*)  # unit/integration tests per crate
```

**Structure Decision**: Single Rust workspace with crates/core and crates/deacon; feature touches lifecycle exec logic in crates/deacon (reusing helpers from crates/core); tests live alongside crate code with fixtures/examples as needed.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None | N/A | Existing structure sufficient |
