# Feature Specification: Workspace Mount Consistency and Git-Root Handling

**Feature Branch**: `006-align-workspace-mounts`  
**Created**: 2025-11-27  
**Status**: Draft  
**Input**: User description: "In our journey to compliance with docs/repomix-output-devcontainers-cli.xml we need to implement: Spec workspace mount consistency/git-root handling: default workspace mount honors consistency flag; git-root detection applied to docker and compose mounts; discovery aligned. Acceptance: workspace mount shows requested consistency; git-root used when flag set for both docker/compose. Use 006 as the numeric identifier."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Workspace mount consistency is honored (Priority: P1)

CLI users set a workspace mount consistency preference and expect every generated workspace mount to reflect that value in both direct Docker runs and Compose flows.

**Why this priority**: It prevents unexpected filesystem semantics that break development experience across engines, and it is the primary acceptance criteria for the feature.

**Independent Test**: Run the CLI once with a chosen consistency value and confirm the resulting workspace mount definition surfaces exactly that value without needing other features enabled.

**Acceptance Scenarios**:

1. **Given** a workspace is auto-discovered, **When** the user provides a workspace mount consistency value, **Then** the generated workspace mount lists that consistency value.
2. **Given** the user targets a Compose-based environment, **When** the same consistency value is provided, **Then** each workspace mount generated for Compose reflects that consistency.

---

### User Story 2 - Git-root mounting for Docker flows (Priority: P2)

CLI users who enable the git-root flag for Docker-based runs want the container to mount the repository root (not merely the current working directory) so tooling sees the full repo context.

**Why this priority**: Ensures Docker runs operate on the expected repository contents, avoiding missing files or misaligned paths.

**Independent Test**: Enable the git-root flag in a repository where the working directory is a subfolder and verify the Docker run configuration mounts the repository root path.

**Acceptance Scenarios**:

1. **Given** a repo where the working directory is not the top-level, **When** the git-root flag is set for a Docker launch, **Then** the mount path resolves to the repository root.

---

### User Story 3 - Git-root mounting for Compose flows (Priority: P3)

Compose users who enable the git-root flag need every service that mounts the workspace to use the detected git root so that multi-service setups share the same repository context.

**Why this priority**: Aligns Compose behavior with Docker runs and prevents service-to-service inconsistencies in mounted content.

**Independent Test**: Enable the git-root flag on a Compose-based project and confirm each generated workspace mount uses the repository root path.

**Acceptance Scenarios**:

1. **Given** a Compose configuration generated by the CLI, **When** the git-root flag is set, **Then** all workspace mounts reference the detected repository root rather than a subdirectory.

---

### Edge Cases

- Git-root flag is set outside a git repository: discovery should fall back to the workspace root and communicate the fallback without failing the launch.
- The workspace root and git root are the same directory: the mount should remain unchanged while still reporting the chosen consistency.
- Projects with nested repositories (e.g., submodules or multiple .git directories): the mount should use the primary repository root discovered by standard git root detection to keep mounts consistent across Docker and Compose.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: The CLI MUST apply the user-provided workspace mount consistency value to the default workspace mount in both Docker and Compose outputs, ensuring the value is visible in generated mount definitions.
- **FR-002**: The CLI MUST retain the standard workspace discovery process when no consistency override is provided, ensuring defaults remain unchanged aside from honoring any provided consistency value.
- **FR-003**: When the git-root flag is enabled, the CLI MUST detect the repository root relative to the working directory using the same discovery logic across invocation modes.
- **FR-004**: For Docker-based runs with the git-root flag, the CLI MUST mount the detected repository root instead of the current working directory while preserving the requested workspace mount consistency.
- **FR-005**: For Compose-based runs with the git-root flag, the CLI MUST mount the detected repository root for every service that receives the workspace mount, matching the Docker behavior.
- **FR-006**: The CLI MUST communicate and gracefully fall back to the workspace root when git-root detection fails (e.g., not a git repository) so launches continue without silent divergence between Docker and Compose outputs.

### Key Entities *(include if feature involves data)*

- **Workspace directory**: The path the CLI identifies as the root of the workspace used for default mounts; may be a subdirectory of a repository.
- **Git root**: The top-level repository directory discovered when the git-root flag is enabled; may differ from the workspace directory.
- **Workspace mount definition**: The generated mount configuration that pairs the host path (workspace or git root) with target locations and includes the chosen consistency value.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% of generated workspace mounts reflect the user-specified consistency value across both Docker and Compose outputs.
- **SC-002**: In repositories where the working directory is beneath the git root, 100% of Docker launches with the git-root flag mount the repository root path rather than the working directory.
- **SC-003**: In the same repositories, 100% of Compose launches with the git-root flag mount the repository root path for every workspace mount, matching Docker behavior.
- **SC-004**: When git-root detection is requested outside a git repository, the CLI surfaces a clear fallback to the workspace root and proceeds without failing in 100% of attempts.

## Assumptions

- Users can already enable a workspace mount consistency option and a git-root flag through existing CLI inputs.
- Docker and Compose environments are available to consume the generated mount definitions without additional configuration changes beyond this feature.
- Standard git root discovery (e.g., detecting the top-level repository directory) remains the agreed mechanism for identifying the repository root.
