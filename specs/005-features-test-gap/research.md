# Research: Features Test GAP Closure

This document consolidates decisions to resolve all NEEDS CLARIFICATION items and captures best practices guiding the design.

## Decisions & Rationale

1. Decision: Keep execution serial (no parallelism) for scenarios/tests in this iteration
   - Rationale: Predictable logs and resource usage; aligns with existing TS CLI behavior and reduces flakiness.
   - Alternatives considered: Parallelizing per-feature or per-scenario with a worker pool; rejected due to log interleaving complexity and need for careful resource controls.

2. Decision: Reuse existing container runtime helpers; avoid expanding trait surface now
   - Rationale: Minimizes scope; existing helpers already support container creation/cleanup and labeling.
   - Alternatives considered: Introduce a new `ContainerRuntime` trait specific to test runs; deferred until broader runtime abstraction work lands.

3. Decision: Strict JSON mode output as single array `[ { "testName": string, "result": boolean } ]`
   - Rationale: Matches feature spec clarification and Constitution V (stdout contract). Ensures easy machine consumption.
   - Alternatives considered: Add additional fields (failureReason, duration) or NDJSON; rejected per spec requirement for strictness.

4. Decision: Global scenarios inclusion policy
   - Rationale: Include `_global` only when no explicit `--features` are provided; exclude otherwise unless `--global-scenarios-only` is set (per spec clarification).
   - Alternatives considered: Always include `_global`; rejected as it violates user expectation when targeting specific features.

5. Decision: Duplicate/idempotence tests are per-feature only
   - Rationale: In `--global-scenarios-only` mode, skip duplicates (per spec clarification FRâ€‘005a).
   - Alternatives considered: Run a synthetic global duplicate test; rejected as semantically unclear.

6. Decision: Filter semantics are case-sensitive substring on scenario names only
   - Rationale: Aligns with spec; avoids ambiguity with feature IDs or filenames.
   - Alternatives considered: Regex or case-insensitive matching; deferred unless future demand arises.

7. Decision: Zero-tests behavior: exit 0; text shows "no tests found"; JSON prints `[]`
   - Rationale: Explicit in spec; supports CI patterns where filtered runs may intentionally match nothing.

## Best Practices Referenced

- Rust CLI: Use `clap` derive for robust argument validation and mutual exclusivity constraints.
- Logging: `tracing` spans aligned to workflows (`feature.test`, `scenario.run`, `cleanup`) with stderr-only logs in JSON mode.
- Testing: Use `assert_cmd` for CLI integration tests; fixtures under `fixtures/` for deterministic scenarios.
- Output Contracts: In JSON mode, print the array to stdout and route all logs to stderr (Constitution V).
- Fail Fast: Validate structure (`src/`, `test/`) before execution; error on missing `test.sh` when autogenerated tests are enabled.

## Clarifications Status

All identified NEEDS CLARIFICATION items are resolved as captured above.
